rules:
  # ===== COMPLIANCE RULES (specific field checks) =====
  - id: s3-public-acls-blocked
    resource_type: AWS::S3::Bucket
    category: compliance
    selector: {}
    check:
      type: equals
      path: PublicAccessBlockConfiguration.BlockPublicAcls
      expected: true
    severity: HIGH
    message: "S3 buckets must block public ACLs"

  - id: s3-ignore-public-acls
    resource_type: AWS::S3::Bucket
    category: compliance
    selector: {}
    check:
      type: equals
      path: PublicAccessBlockConfiguration.IgnorePublicAcls
      expected: true
    severity: HIGH
    message: "S3 buckets must ignore public ACLs"

  - id: s3-block-public-policy
    resource_type: AWS::S3::Bucket
    category: compliance
    selector: {}
    check:
      type: equals
      path: PublicAccessBlockConfiguration.BlockPublicPolicy
      expected: true
    severity: HIGH
    message: "S3 buckets must block public bucket policies"

  - id: s3-restrict-public-buckets
    resource_type: AWS::S3::Bucket
    category: compliance
    selector: {}
    check:
      type: equals
      path: PublicAccessBlockConfiguration.RestrictPublicBuckets
      expected: true
    severity: HIGH
    message: "S3 buckets must restrict public bucket access"

  - id: iam-no-admin-star
    resource_type: AWS::IAM::Policy
    category: compliance
    selector: {}
    check:
      type: forbidden-any
      path: PolicyDocument.Statement[*].Action
      forbidden:
        - "*"
    severity: CRITICAL
    message: "IAM policies must not grant wildcard (*) permissions"

  - id: iam-no-full-admin
    resource_type: AWS::IAM::Policy
    category: compliance
    selector: {}
    check:
      type: forbidden-any
      path: PolicyDocument.Statement[*].Action
      forbidden:
        - "sts:AssumeRole"
        - "ec2:CreateInstance"
        - "ec2:DescribeInstances"
    severity: CRITICAL
    message: "IAM policies must not allow full administrative privileges"

  - id: sg-no-ssh-from-internet
    resource_type: AWS::EC2::SecurityGroup
    category: compliance
    selector: {}
    check:
      type: forbidden-cidr-port
      path: IpPermissions
      params:
        port: 22
        cidr: "0.0.0.0/0"
    severity: CRITICAL
    message: "Security groups must not allow SSH (port 22) from the internet (0.0.0.0/0)"

  - id: sg-no-rdp-from-internet
    resource_type: AWS::EC2::SecurityGroup
    category: compliance
    selector: {}
    check:
      type: forbidden-cidr-port
      path: IpPermissions
      params:
        port: 3389
        cidr: "0.0.0.0/0"
    severity: CRITICAL
    message: "Security groups must not allow RDP (port 3389) from the internet (0.0.0.0/0)"

  # ===== TYPE-LEVEL GOLDEN CONFIGS (full config templates) =====
  - id: s3-golden-public-access-block
    resource_type: AWS::S3::Bucket
    category: type-golden
    selector: {}
    check:
      type: golden-config
      path: PublicAccessBlockConfiguration
      expected:
        BlockPublicAcls: true
        IgnorePublicAcls: true
        BlockPublicPolicy: true
        RestrictPublicBuckets: true
    severity: HIGH
    message: "S3 bucket Public Access Block configuration does not match golden template"

  - id: s3-golden-encryption
    resource_type: AWS::S3::Bucket
    category: type-golden
    selector: {}
    check:
      type: golden-config
      path: ServerSideEncryptionConfiguration
      expected:
        Rules:
          - ApplyServerSideEncryptionByDefault:
              SSEAlgorithm: "AES256"
            BucketKeyEnabled: true
    severity: HIGH
    message: "S3 bucket encryption configuration does not match golden template"

  - id: iam-policy-golden-no-sensitive-actions
    resource_type: AWS::IAM::Policy
    category: type-golden
    selector: {}
    check:
      type: forbidden-any
      path: PolicyDocument.Statement[*].Action
      forbidden:
        - "iam:CreateAccessKey"
        - "iam:CreateUser"
        - "iam:DeleteUser"
        - "iam:AttachUserPolicy"
        - "s3:DeleteBucket"
        - "dynamodb:DeleteTable"
    severity: HIGH
    message: "IAM policy grants sensitive actions that violate golden template"

  # ===== INSTANCE-SPECIFIC GOLDEN CONFIGS (for critical resources) =====
  - id: prod-s3-bucket-golden-config
    resource_type: AWS::S3::Bucket
    category: instance-golden
    selector:
      tags:
        Environment: production
        Critical: "true"
    check:
      type: golden-config
      path: ""
      expected:
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          IgnorePublicAcls: true
          BlockPublicPolicy: true
          RestrictPublicBuckets: true
        ServerSideEncryptionConfiguration:
          Rules:
            - ApplyServerSideEncryptionByDefault:
                SSEAlgorithm: "aws:kms"
                KMSMasterKeyID: "alias/prod-s3-key"
              BucketKeyEnabled: true
        VersioningConfiguration:
          Status: "Enabled"
        LifecycleConfiguration:
          Rules:
            - Status: "Enabled"
              Transitions:
                - Days: 90
                  StorageClass: "GLACIER"
    severity: CRITICAL
    message: "Production S3 bucket configuration does not match strict golden config for critical resources"

  - id: prod-iam-admin-role-golden-config
    resource_type: AWS::IAM::Role
    category: instance-golden
    selector:
      name_pattern: ".*-admin-role"
      tags:
        Environment: production
    check:
      type: golden-config
      path: AssumeRolePolicyDocument
      expected:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              AWS: "arn:aws:iam::123456789012:root"
            Action: "sts:AssumeRole"
            Condition:
              IpAddress:
                aws:SourceIp:
                  - "10.0.0.0/8"
    severity: CRITICAL
    message: "Production admin IAM role trust policy does not match golden config"

